Нужно разбить на нексколько блоков для лучшего дебаггинга 